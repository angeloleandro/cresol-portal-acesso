# Pesquisa: Reestrutura√ß√£o Navbar - An√°lise do Setor "Ag√™ncias"

**Data:** 2025-08-08  
**Contexto:** Separa√ß√£o do setor "Ag√™ncias" do dropdown "Setores" para criar link independente na navbar  
**Arquivos Relacionados:** `/app/components/Navbar.tsx`, `/hooks/useOptimizedNavbar.ts`

## üéØ Objetivo
Conduzir an√°lise t√©cnica sistem√°tica para implementar dropdown independente "Ag√™ncias" na navbar, separando-o do dropdown "Setores" atual.

## üìã Resumo Executivo

A investiga√ß√£o revelou estrutura completa do setor "Ag√™ncias" no Portal Cresol, confirmando viabilidade t√©cnica para implementa√ß√£o do dropdown independente. O setor "Ag√™ncias" possui **31 sub-setores** representando ag√™ncias f√≠sicas distribu√≠das geograficamente, justificando separa√ß√£o devido ao volume significativo e natureza espec√≠fica.

### Descobertas Principais:
- **Setor "Ag√™ncias"**: ID = `5463d1ba-c290-428e-b39e-d7ad9c66eb71`
- **31 sub-setores**: Todas ag√™ncias f√≠sicas distribu√≠das por PR, ES, SP, SC
- **Padr√µes arquiteturais**: Componentes SectorsDropdown e GalleryDropdown como templates
- **Hook otimizado**: useOptimizedSectors j√° implementado com cache inteligente

## üîç Achados Principais

### 1. Database Analysis - Setor "Ag√™ncias"

**Status Atual:**
```
‚úÖ SETOR IDENTIFICADO:
- ID: 5463d1ba-c290-428e-b39e-d7ad9c66eb71
- Nome: "Ag√™ncias" 
- Descri√ß√£o: "Gerencia a opera√ß√£o e o atendimento nas unidades f√≠sicas."
- Total Sub-setores: 31
```

**Sub-setores de Ag√™ncias:**
- **Regi√£o PR (14 ag√™ncias)**: Amp√©re, Barrac√£o, Bela Vista da Caroba, Capanema, Ibaiti, P√©rola d'Oeste, Pinhal de S√£o Bento, Planalto, Pranchita, Realeza, Santa Izabel d'Oeste, Santo Ant√¥nio do Sudoeste
- **Regi√£o ES (12 ag√™ncias)**: Colatina (2 unidades), Governador Lindenberg, Manten√≥polis, Maril√¢ndia, Muniz Freire, Muqui, Nova Ven√©cia, Pancas, Pinheiros, S√£o Gabriel da Palha, Vila Val√©rio
- **Regi√£o SP (4 ag√™ncias)**: Apia√≠, Cap√£o Bonito, Itapeva, S√£o Jos√© dos Campos
- **Regi√£o SC (2 ag√™ncias)**: S√£o Jos√© do Cedro, S√£o Miguel do Oeste
- **Digital (1 ag√™ncia)**: Ag√™ncia Digital Conecta

### 2. Current Implementation Analysis

**Estrutura Atual do Dropdown "Setores":**
```typescript
// hooks/useOptimizedNavbar.ts - useOptimizedSectors()
// Retorna TODOS os 5 setores incluindo "Ag√™ncias"
sectors: [
  "Administrativo" (5 subsectors),
  "Ag√™ncias" (31 subsectors), ‚Üê ALVO DA SEPARA√á√ÉO
  "Comunica√ß√£o & Marketing" (1 subsector),
  "Institucional" (4 subsectors),
  "Neg√≥cios" (9 subsectors)
]
```

**Rendering Pattern no SectorsDropdown:**
```typescript
// app/components/Navbar.tsx - linhas 94-124
{sectors.map((sector) => (
  <div key={sector.id}>
    <Link href={`/setores/${sector.id}`}>
      {sector.name} ‚Üê Inclui "Ag√™ncias" aqui
    </Link>
    {sector.subsectors?.map((subsector) => (
      <Link href={`/subsetores/${subsector.id}`}>
        ‚Ü≥ {subsector.name} ‚Üê 31 ag√™ncias listadas aqui
      </Link>
    ))}
  </div>
))}
```

### 3. Architecture Patterns Analysis

**Template Pattern - SectorsDropdown (linhas 59-127):**
```typescript
const SectorsDropdown = memo(({ pathname, sectors, dropdown }) => (
  <div onMouseEnter={dropdown.handleOpen} onMouseLeave={dropdown.handleClose}>
    <Link href="/setores">Setores</Link>
    {dropdown.isOpen && (
      <div className="dropdown-menu">
        <Link href="/setores">Todos os Setores</Link>
        {sectors.map(sector => (
          // Sector + subsectors rendering
        ))}
      </div>
    )}
  </div>
));
```

**Template Pattern - GalleryDropdown (linhas 130-172):**
```typescript
const GalleryDropdown = memo(({ pathname, dropdown }) => (
  <div onMouseEnter={dropdown.handleOpen} onMouseLeave={dropdown.handleClose}>
    <button>Galeria</button>
    {dropdown.isOpen && (
      <div className="dropdown-menu">
        <Link href="/galeria">Galeria de Imagens</Link>
        <Link href="/videos">Galeria de V√≠deos</Link>
      </div>
    )}
  </div>
));
```

## üèóÔ∏è Architectural Planning

### 1. Component Architecture Design

**AgenciesDropdown Component Pattern:**
```typescript
const AgenciesDropdown = memo(({ pathname, agenciesSubsectors, dropdown }) => (
  <div onMouseEnter={dropdown.handleOpen} onMouseLeave={dropdown.handleClose}>
    <Link href="/setores/5463d1ba-c290-428e-b39e-d7ad9c66eb71">
      Ag√™ncias
    </Link>
    {dropdown.isOpen && (
      <div className="dropdown-menu">
        <Link href="/setores/5463d1ba-c290-428e-b39e-d7ad9c66eb71">
          Todas as Ag√™ncias
        </Link>
        <div className="border-t border-gray-100 mt-1 pt-1">
          {agenciesSubsectors.map(agency => (
            <Link href={`/subsetores/${agency.id}`}>
              {agency.name}
            </Link>
          ))}
        </div>
      </div>
    )}
  </div>
));
```

### 2. Hook Modifications Strategy

**New Hook - useOptimizedAgencies:**
```typescript
export function useOptimizedAgencies(userRole?: string, userId?: string) {
  const [agenciesSubsectors, setAgenciesSubsectors] = useState<Subsector[]>([]);
  const [loading, setLoading] = useState(true);

  const fetchAgencies = useCallback(async () => {
    // Cache key espec√≠fico para ag√™ncias
    const cacheKey = `agencies_${userRole}_${userId}`;
    
    // Query espec√≠fica para setor Ag√™ncias
    const { data } = await supabase
      .from('subsectors')
      .select('id, name, description, sector_id')
      .eq('sector_id', '5463d1ba-c290-428e-b39e-d7ad9c66eb71')
      .order('name');
      
    setAgenciesSubsectors(data || []);
  }, [userRole, userId]);

  return { agenciesSubsectors, loading };
}
```

**Modified Hook - useOptimizedSectors (filtered):**
```typescript
export function useOptimizedSectors(userRole?: string, userId?: string, excludeAgencies = false) {
  // Existing implementation with filter option
  const sectorsData = data || [];
  
  if (excludeAgencies) {
    // Filter out "Ag√™ncias" sector
    const filteredSectors = sectorsData.filter(
      sector => sector.id !== '5463d1ba-c290-428e-b39e-d7ad9c66eb71'
    );
    setSectors(filteredSectors);
  } else {
    setSectors(sectorsData);
  }
}
```

### 3. Navbar Integration Plan

**Desktop Menu Modification (linha 517):**
```typescript
// Current structure
<nav className="flex space-x-4 mr-4">
  <Link href="/home">Home</Link>
  <SectorsDropdown sectors={sectors} /> ‚Üê Modificar para excluir Ag√™ncias
  <AgenciesDropdown agenciesSubsectors={agenciesSubsectors} /> ‚Üê NOVO
  <GalleryDropdown />
  <Link href="/eventos?view=calendar">Calend√°rio</Link>
  <Link href="/sistemas">Sistemas</Link>
</nav>
```

**Mobile Menu Integration (linha 635):**
```typescript
// Adicionar dropdown m√≥vel para Ag√™ncias ap√≥s Setores
<div>
  {/* Existing Setores mobile dropdown */}
</div>

<div> ‚Üê NOVO mobile dropdown para Ag√™ncias
  <div className="flex items-center justify-between py-2" onClick={toggleMobileAgencies}>
    <Link href="/setores/5463d1ba-c290-428e-b39e-d7ad9c66eb71">Ag√™ncias</Link>
    {agenciesSubsectors.length > 0 && (
      <Icon name="chevron-down" className={`h-4 w-4 ${isMobileAgenciesOpen ? 'rotate-180' : ''}`} />
    )}
  </div>
  {/* Render agencies list */}
</div>
```

## üìã Technical Requirements

### 1. Performance Considerations

**Cache Strategy:**
- **Separate cache**: Ag√™ncias ter√£o cache independente com TTL espec√≠fico
- **Reduced payload**: Hook SectorsDropdown ter√° 31 items a menos (62% redu√ß√£o no volume)
- **Parallel loading**: Ag√™ncias e Setores podem ser carregados em paralelo

**Bundle Impact:**
- **Component size**: +~2KB para AgenciesDropdown component
- **Hook overhead**: +~1KB para useOptimizedAgencies hook
- **Net performance**: Melhoria devido √† separa√ß√£o de concerns

### 2. Query Optimization

**Efficient Queries:**
```sql
-- Current query (busca todos os setores + subsectors)
SELECT s.*, sub.* FROM sectors s 
LEFT JOIN subsectors sub ON s.id = sub.sector_id 
ORDER BY s.name, sub.name;

-- New optimized queries (parallel)
-- Query 1: Setores sem Ag√™ncias
SELECT s.*, sub.* FROM sectors s 
LEFT JOIN subsectors sub ON s.id = sub.sector_id 
WHERE s.id != '5463d1ba-c290-428e-b39e-d7ad9c66eb71'
ORDER BY s.name, sub.name;

-- Query 2: Apenas subsectors de Ag√™ncias
SELECT * FROM subsectors 
WHERE sector_id = '5463d1ba-c290-428e-b39e-d7ad9c66eb71' 
ORDER BY name;
```

### 3. TypeScript Interfaces

**New Interfaces Needed:**
```typescript
interface AgencySubsector {
  id: string;
  name: string; 
  description?: string;
  sector_id: string;
}

interface AgenciesDropdownProps {
  pathname: string;
  agenciesSubsectors: AgencySubsector[];
  dropdown: ReturnType<typeof useOptimizedDropdown>;
}
```

## üîó Implementation Roadmap

### Phase 1: Backend/Hook Layer (2-3 hours)
1. **Create useOptimizedAgencies hook** with caching
2. **Modify useOptimizedSectors** to support excludeAgencies flag
3. **Update cache keys** and invalidation logic
4. **Test data fetching** and performance

### Phase 2: Component Layer (2-3 hours) 
1. **Create AgenciesDropdown component** following GalleryDropdown pattern
2. **Implement mobile version** with state management
3. **Update TypeScript interfaces** and props
4. **Add hover/click interactions** consistent with existing dropdowns

### Phase 3: Navbar Integration (1-2 hours)
1. **Integrate AgenciesDropdown** in desktop navbar
2. **Add mobile menu section** for Ag√™ncias 
3. **Update state management** (add mobile toggle states)
4. **Test responsive behavior** and interactions

### Phase 4: Testing & Validation (1-2 hours)
1. **Validate all 31 agencies** load correctly
2. **Test mobile/desktop** switching behavior
3. **Verify performance improvements** with separate caching
4. **Cross-browser compatibility** testing

### Phase 5: Optimization (1 hour)
1. **Code splitting** if needed for bundle optimization
2. **Cache warming strategies** for first load
3. **Error handling** and fallback states
4. **Accessibility testing** and improvements

## üìä Expected Results

### Performance Improvements
- **SectorsDropdown payload**: Redu√ß√£o de ~62% (31 items menos)
- **Initial load**: Parallel fetching de Setores e Ag√™ncias
- **Cache efficiency**: Cache dedicado para dados de Ag√™ncias
- **Memory usage**: Melhor gerenciamento de estado com separa√ß√£o

### UX Benefits
- **Better organization**: Ag√™ncias claramente separadas dos outros setores
- **Improved navigation**: Acesso direto √†s 31 ag√™ncias sem scrolling
- **Visual clarity**: Dropdown "Setores" mais focado (4 setores vs 5)
- **Mobile experience**: Melhor usabilidade em dispositivos m√≥veis

### Maintenance Benefits
- **Separation of concerns**: Ag√™ncias gerenciadas independentemente
- **Scalability**: Facilita futuras expans√µes (filtros por regi√£o, busca)
- **Code clarity**: Componentes especializados e focused responsibility
- **Testing**: Testes independentes para cada dropdown

## üîß Next Steps

### Imediato (Alta Prioridade):
1. **Implementar useOptimizedAgencies hook** com cache dedicado
2. **Criar AgenciesDropdown component** seguindo patterns existentes
3. **Modificar SectorsDropdown** para excluir setor Ag√™ncias

### Curto Prazo (Melhorias importantes):
1. **Integrar mobile navigation** para Ag√™ncias dropdown  
2. **Implementar testes automatizados** para novos componentes
3. **Otimizar performance** com estrat√©gias de cache avan√ßadas

### M√©dio Prazo (Optimiza√ß√µes estrat√©gicas):
1. **Adicionar filtros regionais** para ag√™ncias (PR, ES, SP, SC)
2. **Implementar busca interna** dentro do dropdown Ag√™ncias
3. **Considerar lazy loading** para lista grande de ag√™ncias

---

**üîó Fontes e Refer√™ncias**

**Database**: Supabase - Portal Cresol  
**Setor Target**: "Ag√™ncias" (ID: `5463d1ba-c290-428e-b39e-d7ad9c66eb71`)  
**Subsectors**: 31 ag√™ncias f√≠sicas + 1 ag√™ncia digital  
**Patterns**: SectorsDropdown, GalleryDropdown, useOptimizedDropdown  
**Hooks**: useOptimizedSectors, useOptimizedDropdown, useOptimizedNavbar