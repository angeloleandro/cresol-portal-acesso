import { NextRequest, NextResponse } from 'next/server';
import { createAdminSupabaseClient } from '@/lib/supabase/admin';
import { cookies } from 'next/headers';
import { createServerClient } from '@supabase/ssr';

// Fun√ß√£o para criar cliente do servidor com autentica√ß√£o
async function createAuthenticatedClient() {
  const cookieStore = await cookies();
  
  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll()
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            )
          } catch {
            // O cookie n√£o pode ser modificado no Server Component
          }
        },
      },
    }
  );
}

// POST - Criar not√≠cia ou evento
export async function POST(request: NextRequest) {
  console.log('\nüî∂üî∂üî∂ [API] IN√çCIO DO PROCESSAMENTO POST üî∂üî∂üî∂');
  console.log('‚è∞ [API] Timestamp:', new Date().toISOString());
  console.log('üìç [API] URL completa:', request.url);
  console.log('üìç [API] Method:', request.method);
  
  // Log de todos os headers
  const headers = Object.fromEntries(request.headers.entries());
  console.log('üîë [API] Headers recebidos:');
  Object.entries(headers).forEach(([key, value]) => {
    if (key.toLowerCase().includes('cookie') || key.toLowerCase().includes('auth')) {
      console.log(`  ${key}: ${value.substring(0, 50)}...`);
    } else {
      console.log(`  ${key}: ${value}`);
    }
  });
  
  try {
    console.log('\nüîê [API] ETAPA 1: CRIANDO CLIENTES...');
    const supabase = await createAuthenticatedClient();
    console.log('‚úÖ [API] Cliente autenticado criado para verifica√ß√£o de usu√°rio');
    
    // Criar cliente admin para opera√ß√µes de banco que bypassam RLS
    const adminClient = createAdminSupabaseClient();
    console.log('‚úÖ [API] Cliente admin criado para opera√ß√µes de banco (bypassa RLS)');
    
    // Verificar autentica√ß√£o
    console.log('\nüë§ [API] ETAPA 2: VERIFICANDO USU√ÅRIO...');
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    
    if (authError) {
      console.error('‚ùå‚ùå‚ùå [API] ERRO DE AUTENTICA√á√ÉO:');
      console.error('  Mensagem:', authError.message);
      console.error('  Detalhes:', authError);
      console.error('  Status:', authError.status);
      console.error('  Code:', authError.code);
      return NextResponse.json(
        { 
          error: 'N√£o autorizado', 
          details: authError?.message,
          code: authError?.code,
          status: authError?.status
        },
        { status: 401 }
      );
    }
    
    if (!user) {
      console.error('‚ùå‚ùå‚ùå [API] USU√ÅRIO N√ÉO ENCONTRADO NA SESS√ÉO');
      console.error('  Poss√≠vel problema: Cookies n√£o enviados ou sess√£o expirada');
      return NextResponse.json(
        { error: 'Usu√°rio n√£o encontrado na sess√£o' },
        { status: 401 }
      );
    }
    
    console.log('‚úÖ [API] Usu√°rio autenticado:', {
      id: user.id,
      email: user.email,
      role: user.role,
      aud: user.aud,
      created_at: user.created_at,
      user_metadata: user.user_metadata
    });
    
    // Verificar se √© admin
    console.log('\nüîç [API] ETAPA 3: VERIFICANDO PERFIL E PERMISS√ïES...');
    const { data: profile, error: profileError } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', user.id)
      .single();
    
    if (profileError) {
      console.error('‚ùå‚ùå‚ùå [API] ERRO AO BUSCAR PERFIL:');
      console.error('  Mensagem:', profileError.message);
      console.error('  Detalhes:', profileError);
      console.error('  Code:', profileError.code);
      return NextResponse.json(
        { 
          error: 'Erro ao buscar perfil',
          details: profileError.message
        },
        { status: 500 }
      );
    }
    
    console.log('‚úÖ [API] Perfil encontrado:', {
      id: profile?.id,
      role: profile?.role,
      full_name: profile?.full_name,
      email: profile?.email
    });
    
    if (!profile || (profile.role !== 'admin' && profile.role !== 'sector_admin')) {
      console.error('‚ùå‚ùå‚ùå [API] PERMISS√ÉO NEGADA:');
      console.error('  Role atual:', profile?.role);
      console.error('  Roles permitidos: admin, sector_admin');
      return NextResponse.json(
        { 
          error: 'Permiss√£o negada', 
          role: profile?.role,
          required_roles: ['admin', 'sector_admin']
        },
        { status: 403 }
      );
    }
    
    console.log('‚úÖ [API] Permiss√µes verificadas - usu√°rio autorizado');
    
    // Parse do body
    console.log('\nüì¶ [API] ETAPA 4: PROCESSANDO DADOS...');
    const body = await request.json();
    console.log('üì¶ [API] Body recebido (completo):', JSON.stringify(body, null, 2));
    
    const { type, action, data } = body;
    // Suportar ambos os formatos: 'type' (legado) e 'action' (novo)
    const operationType = action || type;
    console.log('üè∑Ô∏è [API] Tipo de opera√ß√£o:', operationType);
    console.log('üì¶ [API] Dados recebidos:', JSON.stringify(data, null, 2));
    
    // Validar campos obrigat√≥rios para not√≠cias
    console.log('\n‚úÖ [API] ETAPA 5: VALIDANDO CAMPOS...');
    if (type === 'sector_news' || type === 'subsector_news') {
      console.log('üìã [API] Validando campos de not√≠cia...');
      const validation = {
        hasTitle: !!data.title,
        titleLength: data.title?.length || 0,
        hasSummary: !!data.summary,
        summaryLength: data.summary?.length || 0,
        hasContent: !!data.content,
        contentLength: data.content?.length || 0
      };
      console.log('üìã [API] Resultado da valida√ß√£o:', validation);
      
      if (!data.title || !data.summary || !data.content) {
        console.error('‚ùå‚ùå‚ùå [API] CAMPOS OBRIGAT√ìRIOS FALTANDO:', validation);
        return NextResponse.json(
          { 
            error: 'Campos obrigat√≥rios faltando',
            missing: {
              title: !data.title,
              summary: !data.summary,
              content: !data.content
            },
            validation
          },
          { status: 400 }
        );
      }
      console.log('‚úÖ [API] Todos os campos obrigat√≥rios presentes');
    }
    
    // Validar campos obrigat√≥rios para eventos
    if (type === 'sector_events' || type === 'subsector_events') {
      console.log('üìã [API] Validando campos de evento...');
      const validation = {
        hasTitle: !!data.title,
        titleLength: data.title?.length || 0,
        hasDescription: !!data.description,
        descriptionLength: data.description?.length || 0,
        hasStartDate: !!data.start_date,
        startDateValue: data.start_date
      };
      console.log('üìã [API] Resultado da valida√ß√£o:', validation);
      
      if (!data.title || !data.description || !data.start_date) {
        console.error('‚ùå‚ùå‚ùå [API] CAMPOS OBRIGAT√ìRIOS FALTANDO:', validation);
        return NextResponse.json(
          { 
            error: 'Campos obrigat√≥rios faltando',
            missing: {
              title: !data.title,
              description: !data.description,
              start_date: !data.start_date
            },
            validation
          },
          { status: 400 }
        );
      }
      console.log('‚úÖ [API] Todos os campos obrigat√≥rios presentes');
    }
    
    // Adicionar created_by
    console.log('\nüîß [API] ETAPA 6: PREPARANDO DADOS PARA INSER√á√ÉO...');
    const enrichedData = {
      ...data,
      created_by: user.id
    };
    
    console.log('üîß [API] Dados enriquecidos:', JSON.stringify(enrichedData, null, 2));
    console.log('üîß [API] user.id que ser√° usado como created_by:', user.id);
    
    let result;
    let error;
    
    // INSER√á√ÉO NO BANCO
    console.log('\nüíæ [API] ETAPA 7: INSERINDO NO BANCO DE DADOS...');
    console.log('üîë [API] Usando cliente autenticado com contexto do usu√°rio');
    console.log('üîë [API] auth.uid() no contexto ser√°:', user.id);
    console.log('üîë [API] Tipo de cliente: Admin Client (SERVICE ROLE - bypassa RLS)');
    
    switch (operationType) {
      case 'create_news':
      case 'sector_news':
        console.log('\nüì® [API] Caso: SECTOR_NEWS');
        console.log('üì® [API] Tabela alvo: sector_news');
        console.log('üì® [API] Dados completos para inser√ß√£o:', JSON.stringify(enrichedData, null, 2));
        console.log('üì® [API] Executando INSERT...');
        
        try {
          ({ data: result, error } = await adminClient
            .from('sector_news')
            .insert(enrichedData)
            .select()
            .single());
          
          if (error) {
            console.error('\n‚ùå‚ùå‚ùå [API] ERRO NA INSER√á√ÉO SECTOR_NEWS:');
            console.error('  Tipo de erro:', error.constructor.name);
            console.error('  Mensagem:', error.message);
            console.error('  Detalhes:', error.details);
            console.error('  Hint:', error.hint);
            console.error('  Code:', error.code);
            console.error('  Objeto completo:', JSON.stringify(error, null, 2));
          } else {
            console.log('\n‚úÖ‚úÖ‚úÖ [API] INSER√á√ÉO SECTOR_NEWS BEM-SUCEDIDA!');
            console.log('  ID criado:', result?.id);
            console.log('  Dados inseridos:', JSON.stringify(result, null, 2));
          }
        } catch (insertError: any) {
          console.error('\nüí•üí•üí• [API] EXCE√á√ÉO NA INSER√á√ÉO:');
          console.error('  Tipo:', insertError.constructor.name);
          console.error('  Mensagem:', insertError.message);
          console.error('  Stack:', insertError.stack);
          error = insertError;
        }
        break;
        
      case 'sector_events':
        console.log('üìÖ [API POST] Inserindo em sector_events com contexto de usu√°rio...');
        console.log('üìÖ [API POST] Dados para inser√ß√£o:', enrichedData);
        ({ data: result, error } = await supabase
          .from('sector_events')
          .insert(enrichedData)
          .select()
          .single());
        console.log('üìÖ [API POST] Resultado sector_events:', { 
          success: !!result && !error,
          resultId: result?.id,
          error: error?.message,
          errorDetails: error?.details,
          errorHint: error?.hint
        });
        break;
        
      case 'subsector_news':
        console.log('üì∞ [API POST] Inserindo em subsector_news com contexto de usu√°rio...');
        console.log('üì∞ [API POST] Dados para inser√ß√£o:', enrichedData);
        ({ data: result, error } = await supabase
          .from('subsector_news')
          .insert(enrichedData)
          .select()
          .single());
        console.log('üì∞ [API POST] Resultado subsector_news:', { 
          success: !!result && !error,
          resultId: result?.id,
          error: error?.message,
          errorDetails: error?.details,
          errorHint: error?.hint
        });
        break;
        
      case 'subsector_events':
        console.log('üóìÔ∏è [API POST] Inserindo em subsector_events com contexto de usu√°rio...');
        console.log('üóìÔ∏è [API POST] Dados para inser√ß√£o:', enrichedData);
        ({ data: result, error } = await supabase
          .from('subsector_events')
          .insert(enrichedData)
          .select()
          .single());
        console.log('üóìÔ∏è [API POST] Resultado subsector_events:', { 
          success: !!result && !error,
          resultId: result?.id,
          error: error?.message,
          errorDetails: error?.details,
          errorHint: error?.hint
        });
        break;
        
      case 'update_news':
        console.log('\nüì® [API] Caso: UPDATE_NEWS (fallback para compatibilidade)');
        console.log('üì® [API] Tabela alvo: sector_news');
        console.log('üì® [API] ID para atualiza√ß√£o:', enrichedData.id);
        
        if (!enrichedData.id) {
          return NextResponse.json(
            { error: 'ID √© obrigat√≥rio para atualiza√ß√£o' },
            { status: 400 }
          );
        }
        
        const { id: newsId, created_by: newsCreatedBy, created_at: newsCreatedAt, ...newsUpdateData } = enrichedData;
        newsUpdateData.updated_at = new Date().toISOString();
        
        ({ data: result, error } = await adminClient
          .from('sector_news')
          .update(newsUpdateData)
          .eq('id', newsId)
          .select()
          .single());
          
        if (error) {
          console.error('\n‚ùå‚ùå‚ùå [API] ERRO NA ATUALIZA√á√ÉO SECTOR_NEWS:', error);
        } else {
          console.log('\n‚úÖ‚úÖ‚úÖ [API] ATUALIZA√á√ÉO SECTOR_NEWS BEM-SUCEDIDA!');
        }
        break;
        
      case 'update_subsector_news':
        console.log('\nüì® [API] Caso: UPDATE_SUBSECTOR_NEWS');
        console.log('üì® [API] Tabela alvo: subsector_news');
        console.log('üì® [API] ID para atualiza√ß√£o:', enrichedData.id);
        
        if (!enrichedData.id) {
          return NextResponse.json(
            { error: 'ID √© obrigat√≥rio para atualiza√ß√£o' },
            { status: 400 }
          );
        }
        
        const { id: subsectorNewsId, created_by: subsectorNewsCreatedBy, created_at: subsectorNewsCreatedAt, ...subsectorNewsUpdateData } = enrichedData;
        subsectorNewsUpdateData.updated_at = new Date().toISOString();
        
        ({ data: result, error } = await adminClient
          .from('subsector_news')
          .update(subsectorNewsUpdateData)
          .eq('id', subsectorNewsId)
          .select()
          .single());
          
        if (error) {
          console.error('\n‚ùå‚ùå‚ùå [API] ERRO NA ATUALIZA√á√ÉO SUBSECTOR_NEWS:', error);
        } else {
          console.log('\n‚úÖ‚úÖ‚úÖ [API] ATUALIZA√á√ÉO SUBSECTOR_NEWS BEM-SUCEDIDA!');
        }
        break;
        
      case 'update_event':
        console.log('\nüìÖ [API] Caso: UPDATE_EVENT (fallback para compatibilidade)');
        console.log('üìÖ [API] Tabela alvo: sector_events');
        console.log('üìÖ [API] ID para atualiza√ß√£o:', enrichedData.id);
        
        if (!enrichedData.id) {
          return NextResponse.json(
            { error: 'ID √© obrigat√≥rio para atualiza√ß√£o' },
            { status: 400 }
          );
        }
        
        const { id: eventId, created_by: eventCreatedBy, created_at: eventCreatedAt, ...eventUpdateData } = enrichedData;
        eventUpdateData.updated_at = new Date().toISOString();
        
        ({ data: result, error } = await adminClient
          .from('sector_events')
          .update(eventUpdateData)
          .eq('id', eventId)
          .select()
          .single());
          
        if (error) {
          console.error('\n‚ùå‚ùå‚ùå [API] ERRO NA ATUALIZA√á√ÉO SECTOR_EVENTS:', error);
        } else {
          console.log('\n‚úÖ‚úÖ‚úÖ [API] ATUALIZA√á√ÉO SECTOR_EVENTS BEM-SUCEDIDA!');
        }
        break;
        
      default:
        console.error('‚ùå [API POST] Tipo inv√°lido:', operationType);
        return NextResponse.json(
          { error: 'Tipo inv√°lido', receivedType: operationType },
          { status: 400 }
        );
    }
    
    console.log('\nüîç [API] ETAPA 8: AVALIANDO RESULTADO...');
    if (error) {
      console.error('\nüí•üí•üí• [API] ERRO AO CRIAR CONTE√öDO:');
      console.error('  Tipo de erro:', error.constructor?.name || 'Unknown');
      console.error('  Mensagem:', error.message);
      console.error('  Detalhes:', error.details);
      console.error('  Hint:', error.hint);
      console.error('  Code:', error.code);
      console.error('  Dados que causaram erro:', JSON.stringify(enrichedData, null, 2));
      console.error('  Erro completo:', JSON.stringify(error, null, 2));
      console.error('üî∂üî∂üî∂ [API] FIM DO PROCESSAMENTO - ERRO üî∂üî∂üî∂\n');
      
      return NextResponse.json(
        { 
          error: error.message,
          details: error.details,
          hint: error.hint,
          code: error.code,
          sentData: enrichedData
        },
        { status: 400 }
      );
    }
    
    console.log('\n‚úÖ‚úÖ‚úÖ [API] SUCESSO TOTAL!');
    console.log('  Resultado final:', JSON.stringify(result, null, 2));
    console.log('üî∂üî∂üî∂ [API] FIM DO PROCESSAMENTO - SUCESSO üî∂üî∂üî∂\n');
    
    return NextResponse.json({ data: result });
    
  } catch (error: any) {
    console.error('\nüî•üî•üî• [API] ERRO CR√çTICO NO SERVIDOR:');
    console.error('  Tipo:', error.constructor?.name || 'Unknown');
    console.error('  Mensagem:', error.message);
    console.error('  Stack:', error.stack);
    console.error('  Erro completo:', error);
    console.error('üî∂üî∂üî∂ [API] FIM DO PROCESSAMENTO - ERRO CR√çTICO üî∂üî∂üî∂\n');
    
    return NextResponse.json(
      { 
        error: 'Erro interno do servidor',
        message: error.message,
        type: error.constructor?.name || 'Unknown',
        stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
      },
      { status: 500 }
    );
  }
}

// PUT - Atualizar not√≠cia ou evento
export async function PUT(request: NextRequest) {
  console.log('üîÑ [API PUT] Requisi√ß√£o recebida');
  console.log('üïë [API PUT] Timestamp:', new Date().toISOString());
  
  try {
    const supabase = await createAuthenticatedClient();
    
    // Verificar autentica√ß√£o
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    
    if (authError || !user) {
      console.error('‚ùå [API PUT] Usu√°rio n√£o autenticado');
      return NextResponse.json(
        { error: 'N√£o autorizado' },
        { status: 401 }
      );
    }
    
    // Verificar se √© admin
    const { data: profile } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single();
    
    if (!profile || (profile.role !== 'admin' && profile.role !== 'sector_admin')) {
      console.error('‚ùå [API PUT] Permiss√£o negada');
      return NextResponse.json(
        { error: 'Permiss√£o negada' },
        { status: 403 }
      );
    }
    
    const body = await request.json();
    console.log('üì¶ [API PUT] Body recebido:', body);
    
    const { type, id, data } = body;
    
    let result;
    let error;
    
    // CORRE√á√ÉO: Usar o adminClient (SERVICE ROLE) para evitar problemas de RLS ao despublicar
    console.log('üîë [API PUT] Usando adminClient (SERVICE ROLE) para opera√ß√£o de UPDATE...');
    
    // Criar cliente admin para bypassar RLS (necess√°rio para despublica√ß√£o)
    const adminClient = createAdminSupabaseClient();
    
    switch (type) {
      case 'sector_news':
        ({ data: result, error } = await adminClient
          .from('sector_news')
          .update(data)
          .eq('id', id)
          .select()
          .single());
        break;
        
      case 'sector_events':
        ({ data: result, error } = await adminClient
          .from('sector_events')
          .update(data)
          .eq('id', id)
          .select()
          .single());
        break;
        
      case 'subsector_news':
        ({ data: result, error } = await adminClient
          .from('subsector_news')
          .update(data)
          .eq('id', id)
          .select()
          .single());
        break;
        
      case 'subsector_events':
        ({ data: result, error } = await adminClient
          .from('subsector_events')
          .update(data)
          .eq('id', id)
          .select()
          .single());
        break;
        
      default:
        return NextResponse.json(
          { error: 'Tipo inv√°lido' },
          { status: 400 }
        );
    }
    
    if (error) {
      console.error('üí• [API PUT] Erro ao atualizar conte√∫do:', error);
      return NextResponse.json(
        { error: error.message },
        { status: 400 }
      );
    }
    
    console.log('‚úÖ [API PUT] Atualizado com sucesso');
    return NextResponse.json({ data: result });
    
  } catch (error: any) {
    console.error('üî• [API PUT] Erro no servidor:', error);
    return NextResponse.json(
      { error: 'Erro interno do servidor' },
      { status: 500 }
    );
  }
}

// DELETE - Excluir not√≠cia ou evento
export async function DELETE(request: NextRequest) {
  console.log('üóëÔ∏è [API DELETE] Requisi√ß√£o recebida');
  console.log('üïë [API DELETE] Timestamp:', new Date().toISOString());
  
  try {
    const supabase = await createAuthenticatedClient();
    
    // Verificar autentica√ß√£o
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    
    if (authError || !user) {
      console.error('‚ùå [API DELETE] Usu√°rio n√£o autenticado');
      return NextResponse.json(
        { error: 'N√£o autorizado' },
        { status: 401 }
      );
    }
    
    // Verificar se √© admin
    const { data: profile } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single();
    
    if (!profile || (profile.role !== 'admin' && profile.role !== 'sector_admin')) {
      console.error('‚ùå [API DELETE] Permiss√£o negada');
      return NextResponse.json(
        { error: 'Permiss√£o negada' },
        { status: 403 }
      );
    }
    
    const { searchParams } = new URL(request.url);
    const type = searchParams.get('type');
    const id = searchParams.get('id');
    
    console.log('üóëÔ∏è [API DELETE] Par√¢metros:', { type, id });
    
    if (!type || !id) {
      return NextResponse.json(
        { error: 'Par√¢metros faltando' },
        { status: 400 }
      );
    }
    
    let error;
    
    // CORRE√á√ÉO: Usar o adminClient (SERVICE ROLE) para opera√ß√µes de DELETE
    console.log('üîë [API DELETE] Usando adminClient (SERVICE ROLE) para opera√ß√£o de DELETE...');
    
    // Criar cliente admin para bypassar RLS
    const adminClient = createAdminSupabaseClient();
    
    switch (type) {
      case 'sector_news':
        ({ error } = await adminClient
          .from('sector_news')
          .delete()
          .eq('id', id));
        break;
        
      case 'sector_events':
        ({ error } = await adminClient
          .from('sector_events')
          .delete()
          .eq('id', id));
        break;
        
      case 'subsector_news':
        ({ error } = await adminClient
          .from('subsector_news')
          .delete()
          .eq('id', id));
        break;
        
      case 'subsector_events':
        ({ error } = await adminClient
          .from('subsector_events')
          .delete()
          .eq('id', id));
        break;
        
      default:
        return NextResponse.json(
          { error: 'Tipo inv√°lido' },
          { status: 400 }
        );
    }
    
    if (error) {
      console.error('üí• [API DELETE] Erro ao excluir conte√∫do:', error);
      return NextResponse.json(
        { error: error.message },
        { status: 400 }
      );
    }
    
    console.log('‚úÖ [API DELETE] Exclu√≠do com sucesso');
    return NextResponse.json({ success: true });
    
  } catch (error: any) {
    console.error('üî• [API DELETE] Erro no servidor:', error);
    return NextResponse.json(
      { error: 'Erro interno do servidor' },
      { status: 500 }
    );
  }
}